<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>ELMA-Suite ¬∑ Herramientas acad√©micas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    :root {
      --azul-fondo-1: #d6eaff;
      --azul-fondo-2: #b3d5ff;
      --azul-texto: #003366;
      --azul-boton: #0d6efd;
      --azul-boton-hover: #0b63c5;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(135deg, var(--azul-fondo-1), var(--azul-fondo-2));
    }
    .card {
      background: #ffffff;
      padding: 32px 40px;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.12);
      max-width: 540px;
      width: 100%;
      text-align: center;
    }
    h1 {
      margin: 0 0 12px;
      font-size: 1.95rem;
      color: var(--azul-texto);
    }
    p {
      margin: 0 0 20px;
      color: #34495e;
    }
    label {
      display: block;
      text-align: left;
      margin-bottom: 6px;
      font-weight: 500;
      color: var(--azul-texto);
    }
    input {
      width: 100%;
      padding: 12px 16px;
      margin-bottom: 16px;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    input:focus {
      outline: none;
      border-color: var(--azul-boton);
      box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.1);
    }
    .buttons {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 16px;
    }
    a.btn {
      display: block;
      padding: 12px 20px;
      border-radius: 999px;
      text-decoration: none;
      font-weight: 600;
      border: 1px solid var(--azul-boton-hover);
      background: var(--azul-boton);
      color: #ffffff;
      transition: all 0.2s ease;
    }
    a.btn.secondary {
      background: #ffffff;
      color: var(--azul-boton);
      border-color: var(--azul-boton);
    }
    a.btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
      background: var(--azul-boton-hover);
    }
    a.btn.secondary:hover {
      background: #f0f7ff;
      color: var(--azul-boton-hover);
      border-color: var(--azul-boton-hover);
    }
    small {
      display: block;
      margin-top: 24px;
      font-size: 0.85rem;
      color: #64748b;
    }
    .menu-extra {
      margin-top: 16px;
      display: flex;
      justify-content: center;
      gap: 24px;
      flex-wrap: wrap;
    }
    .menu-link-btn {
      border: none;
      background: none;
      color: var(--azul-boton);
      text-decoration: underline;
      cursor: pointer;
      font-size: 0.9rem;
      padding: 0;
      transition: color 0.2s;
    }
    .menu-link-btn:hover {
      color: var(--azul-boton-hover);
    }
    .loading {
      color: var(--azul-boton);
      font-style: italic;
      margin: 12px 0;
    }
    .login-error {
      color: #dc2626;
      margin-top: 12px;
      font-size: 0.95rem;
      min-height: 1.2em;
    }
  </style>

  <script src="decoder.js"></script>
</head>
<body>

  <!-- LOGIN -->
  <div class="card" id="login-card">
    <h1>ELMA-Suite</h1>
    <p>Acceso docente. Ingrese su c√≥digo institucional y contrase√±a.</p>
    <div id="loading-users" class="loading" style="display:none;">Cargando lista de usuarios‚Ä¶</div>
    <form id="login-form">
      <div>
        <label for="user-code">C√≥digo de usuario</label>
        <input id="user-code" type="text" autocomplete="off" required placeholder="Ej: S-AGUILI2026">
      </div>
      <div>
        <label for="user-pass">Contrase√±a</label>
        <input id="user-pass" type="password" autocomplete="off" required>
      </div>
      <button type="submit" class="btn">Iniciar sesi√≥n</button>
      <div class="login-error" id="login-error"></div>
    </form>
  </div>

  <!-- MEN√ö PRINCIPAL -->
  <div class="card" id="menu-card" style="display:none;">
    <h1>ELMA-Suite</h1>
    <p id="menu-subtitle">Herramientas acad√©micas para planeamientos y r√∫bricas.</p>

    <div class="buttons">
      <a class="btn" href="generador_planeamientos_v1_0/index.html">Generador de Planeamientos</a>
      <a class="btn secondary" href="Rubricas_ELMA_Secundaria_v1_1_2/index.html">Generador de R√∫bricas</a>
      <a class="btn" href="ICPI/icpi.html">M√≥dulo de Proyectos</a>
    </div>

    <div class="menu-extra">
      <button type="button" id="btn-open-change-menu" class="menu-link-btn">Cambiar contrase√±a</button>
      <button type="button" id="btn-logout" class="menu-link-btn">Cerrar sesi√≥n</button>
    </div>

    <div class="menu-extra" id="admin-panel-button" style="display:none; margin-top:8px;">
      <button type="button" class="menu-link-btn" id="btn-open-admin">Administraci√≥n de Usuarios</button>
    </div>

    <div id="change-pass-panel-menu" style="display:none; margin-top:16px; text-align:left;">
      <form id="change-pass-form-menu">
        <label>Contrase√±a actual</label>
        <input id="current-pass-menu" type="password" autocomplete="off" required>
        <label style="margin-top:8px;">Nueva contrase√±a</label>
        <input id="new-pass-menu" type="password" autocomplete="off" required>
        <label style="margin-top:8px;">Confirmar nueva contrase√±a</label>
        <input id="new-pass2-menu" type="password" autocomplete="off" required>
        <button type="submit" class="btn" style="margin-top:16px;">Guardar cambios</button>
        <div class="login-error" id="change-pass-error-menu"></div>
      </form>
    </div>

    <small>ELMA-Suite v1.0 Institucional ¬∑ Escuela Liceo Mar√≠a Auxiliadora ¬∑ Uso interno docente</small>
  </div>

<script src="admin.js"></script>
<script>
document.getElementById("btn-open-admin").onclick = openAdmin;
</script>

<script>
// =============================================================================
// SISTEMA DE USUARIOS ‚Äî FUENTE √öNICA: users.enc
// =============================================================================
let ELMA_USERS = [];  // Se llena desde decoder.js

const ELMA_SNIT_KEY = "k9R!t6$X2mQp";
const ADMIN_CODE = "S-ADMIN2026";
const INITIAL_ACCESS_KEY = "ELMA2026";

// =============================================================================
// FUNCI√ìN PARA NORMALIZAR NOMBRES A TITLE CASE
// =============================================================================
function toTitleCase(str) {
  if (!str) return "";
  return str
    .toLowerCase()
    .split(/\s+/)
    .map(word => {
      const lowers = ['de', 'del', 'la', 'las', 'los', 'el', 'y', 'o', 'a'];
      if (lowers.includes(word)) return word;
      return word.charAt(0).toUpperCase() + word.slice(1);
    })
    .join(' ');
}

// =============================================================================
// FUNCIONES DE HASH Y ALMACENAMIENTO
// =============================================================================
function elma_generateSalt() {
  return crypto.randomUUID();
}
async function elma_hash(text) {
  const uint8 = new TextEncoder().encode(text);
  const digest = await crypto.subtle.digest("SHA-256", uint8);
  return Array.from(new Uint8Array(digest))
    .map(b => b.toString(16).padStart(2, "0"))
    .join("");
}
function elma_storeHash(code, hash, salt) {
  localStorage.setItem("elmaPass-" + code, JSON.stringify({ hash, salt }));
}
function elma_getStoredHash(code) {
  const raw = localStorage.getItem("elmaPass-" + code);
  if (!raw) return null;
  try { return JSON.parse(raw); } catch { return null; }
}

// =============================================================================
// UTILITARIOS
// =============================================================================
let currentUser = null;

function findUserByCode(code) {
  const searchCode = (code || "").trim().toUpperCase();
  return ELMA_USERS.find(u => (u.code || "").toUpperCase() === searchCode) || null;
}

const loginCard = document.getElementById("login-card");
const menuCard = document.getElementById("menu-card");
const menuSubtitle = document.getElementById("menu-subtitle");
const loadingUsersEl = document.getElementById("loading-users");

function showMenu(user) {
  loginCard.style.display = "none";
  menuCard.style.display = "block";
  currentUser = user;

  const displayName = toTitleCase(user.name || "");
  menuSubtitle.textContent = `Bienvenido(a), ${displayName}. Herramientas acad√©micas para planeamientos y r√∫bricas.`;

  // üî• SOLO el administrador ve el bot√≥n de "Administraci√≥n de Usuarios"
  const adminButton = document.getElementById("admin-panel-button");
  if (adminButton) {
    adminButton.style.display = (user.code === "S-ADMIN2026") ? "block" : "none";
  }

  // Bot√≥n de recuperaci√≥n de contrase√±as (solo para admin)
  if (user.code === "S-ADMIN2026" && !document.getElementById("elma-admin-recovery")) {
    const cont = document.createElement("div");
    cont.style.marginTop = "20px";
    cont.innerHTML = `
      <button class="btn" id="elma-admin-recovery"
        style="background:#146c43;border-color:#146c43;">
        Administraci√≥n de contrase√±as
      </button>
    `;
    menuCard.appendChild(cont);
    document.getElementById("elma-admin-recovery").onclick = () => {
      elma_showAdminRecovery();
    };
  }

  console.log(`‚úÖ Sesi√≥n iniciada como: ${user.code} (${displayName})`);
}


function showLogin() {
  currentUser = null;
  menuCard.style.display = "none";
  loginCard.style.display = "block";
  document.getElementById("login-error").textContent = "";
  document.getElementById("user-code").value = "";
  document.getElementById("user-pass").value = "";
}

// =============================================================================
// CARGA DE USUARIOS DESDE users.enc + NORMALIZACI√ìN
// =============================================================================
async function loadUsersFromEnc() {
  loadingUsersEl.style.display = "block";
  try {
    const users = await window.decoder.loadUsers();
    if (Array.isArray(users) && users.length > 0) {
      ELMA_USERS = users.map(user => ({
        ...user,
        name: toTitleCase(user.name || "")
      }));
      console.log(`Cargados y normalizados ${ELMA_USERS.length} usuarios desde users.enc`);
    } else {
      console.warn("users.enc cargado pero vac√≠o o inv√°lido");
      alert("No se encontraron usuarios v√°lidos en users.enc. Contacte al administrador.");
    }
  } catch (err) {
    console.error("Error al cargar users.enc:", err);
    alert("No se pudo cargar la lista de usuarios.\nVerifique que decoder.js y users.enc est√©n disponibles.\nError: " + err.message);
  } finally {
    loadingUsersEl.style.display = "none";
  }
}

loadUsersFromEnc();

// =============================================================================
// LOGIN
// =============================================================================
const formLogin = document.getElementById("login-form");
const codeInput = document.getElementById("user-code");
const passInput = document.getElementById("user-pass");
const loginError = document.getElementById("login-error");

formLogin.addEventListener("submit", async ev => {
  ev.preventDefault();
  loginError.textContent = "";

  const code = codeInput.value.trim();
  const pass = passInput.value.trim();

  if (ELMA_USERS.length === 0) {
    loginError.textContent = "Cargando lista de usuarios‚Ä¶ espere un momento.";
    for (let i = 0; i < 4; i++) {
      await new Promise(r => setTimeout(r, 800));
      if (ELMA_USERS.length > 0) break;
    }
    if (ELMA_USERS.length === 0) {
      loginError.textContent = "No se pudo cargar la lista de usuarios. Recargue la p√°gina.";
      return;
    }
  }

  const user = findUserByCode(code);
  if (!user) {
    loginError.textContent = "C√≥digo de usuario no reconocido.";
    return;
  }

  const stored = elma_getStoredHash(user.code);
  if (stored) {
    const h = await elma_hash(stored.salt + pass);
    if (h !== stored.hash) {
      loginError.textContent = "Contrase√±a incorrecta.";
      return;
    }
    localStorage.setItem("elmaUser", user.code);
    showMenu(user);
    return;
  }

  // No tiene hash guardado ‚Üí siempre primera vez
  const newPass = elma_generatePassword();
  const salt = elma_generateSalt();
  const hash = await elma_hash(salt + newPass);
  elma_storeHash(user.code, hash, salt);

  elma_showAutoPassword(user);
  localStorage.setItem("elmaUser", user.code);
  showMenu(user);
});

// Restaurar sesi√≥n
(function restoreLogin() {
  const last = localStorage.getItem("elmaUser");
  if (!last) return;
  if (ELMA_USERS.length === 0) {
    const check = setInterval(() => {
      if (ELMA_USERS.length > 0) {
        clearInterval(check);
        const u = findUserByCode(last);
        if (u) showMenu(u);
      }
    }, 600);
    setTimeout(() => clearInterval(check), 5000);
  } else {
    const u = findUserByCode(last);
    if (u) showMenu(u);
  }
})();

// =============================================================================
// GENERAR CONTRASE√ëA + POPUP + PDF
// =============================================================================
function elma_generatePassword() {
  const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789@$%&*?";
  let res = "";
  for (let i = 0; i < 10; i++) {
    res += chars[Math.floor(Math.random() * chars.length)];
  }
  return res;
}

function elma_createPopup(html) {
  const wrap = document.createElement("div");
  wrap.style.position = "fixed";
  wrap.style.inset = "0";
  wrap.style.background = "rgba(0,0,0,0.5)";
  wrap.style.display = "flex";
  wrap.style.alignItems = "center";
  wrap.style.justifyContent = "center";
  wrap.style.zIndex = "9999";
  wrap.innerHTML = `
    <div style="background:#fff;padding:28px;border-radius:12px;max-width:420px;text-align:center;box-shadow:0 8px 32px rgba(0,0,0,0.2);">
      ${html}
      <button style="margin-top:20px;padding:10px 24px;font-weight:600;border:none;border-radius:8px;background:var(--azul-boton);color:white;cursor:pointer;" id="elmaOKbtn">Aceptar</button>
    </div>
  `;
  document.body.appendChild(wrap);
  document.getElementById("elmaOKbtn").onclick = () => wrap.remove();
}

function elma_downloadPDF(user, password) {
  const win = window.open("", "_blank");
  win.document.write(`
    <h2>Credenciales ELMA-Suite</h2>
    <p><b>Docente:</b> ${toTitleCase(user.name)}</p>
    <p><b>C√≥digo:</b> ${user.code}</p>
    <p><b>Contrase√±a generada:</b> ${password}</p>
    <p>Recomendamos cambiar esta contrase√±a desde el men√∫ principal.</p>
  `);
  win.print();
  win.close();
}

async function elma_showAutoPassword(user) {
  const password = elma_generatePassword();
  const salt = elma_generateSalt();
  const hash = await elma_hash(salt + password);
  elma_storeHash(user.code, hash, salt);
  elma_createPopup(`
    <h3>Contrase√±a generada</h3>
    <p>Bienvenido(a) ${toTitleCase(user.name)}.</p>
    <p>Su contrase√±a es:</p>
    <p style="font-size:1.4rem;font-weight:700;color:var(--azul-texto);letter-spacing:1px;">${password}</p>
    <p style="margin-top:16px;color:#dc2626;font-weight:500;">Gu√°rdela en un lugar seguro.</p>
    <button id="elmaPDFbtn" style="margin-top:16px;padding:10px 20px;border:1px solid var(--azul-texto);background:white;color:var(--azul-texto);font-weight:600;border-radius:8px;cursor:pointer;">
      Descargar PDF
    </button>
  `);
  document.getElementById("elmaPDFbtn").onclick = () => elma_downloadPDF(user, password);
}

// =============================================================================
// CAMBIO DE CONTRASE√ëA
// =============================================================================
const changeMenuBtn = document.getElementById('btn-open-change-menu');
const changePanelMenu = document.getElementById('change-pass-panel-menu');
const changeFormMenu = document.getElementById('change-pass-form-menu');
const currentPassMenu = document.getElementById('current-pass-menu');
const newPassMenu = document.getElementById('new-pass-menu');
const newPass2Menu = document.getElementById('new-pass2-menu');
const changeErrorMenu = document.getElementById('change-pass-error-menu');

changeMenuBtn.onclick = () => {
  changePanelMenu.style.display = changePanelMenu.style.display === "block" ? "none" : "block";
  changeErrorMenu.textContent = "";
};

changeFormMenu.addEventListener("submit", async ev => {
  ev.preventDefault();
  changeErrorMenu.textContent = "";
  if (!currentUser) return;

  const stored = elma_getStoredHash(currentUser.code);
  const c = currentPassMenu.value;
  const np1 = newPassMenu.value;
  const np2 = newPass2Menu.value;

  if (np1 !== np2) {
    changeErrorMenu.textContent = "Las contrase√±as nuevas no coinciden.";
    return;
  }

  const h = await elma_hash(stored.salt + c);
  if (h !== stored.hash) {
    changeErrorMenu.textContent = "Contrase√±a actual incorrecta.";
    return;
  }

  const salt = elma_generateSalt();
  const hash = await elma_hash(salt + np1);
  elma_storeHash(currentUser.code, hash, salt);
  changeErrorMenu.style.color = "#10b981";
  changeErrorMenu.textContent = "Contrase√±a actualizada correctamente.";
});

// =============================================================================
// CERRAR SESI√ìN
// =============================================================================
document.getElementById('btn-logout').onclick = () => {
  localStorage.removeItem("elmaUser");
  showLogin();
};

// =============================================================================
// RECUPERACI√ìN ADMIN (SNIT)
// =============================================================================
function elma_showAdminRecovery() {
  const list = ELMA_USERS
    .map(u => `<option value="${u.code}">${u.name} (${u.code})</option>`)
    .join("");
  elma_createPopup(`
    <h3>Recuperaci√≥n de contrase√±as</h3>
    <p>Seleccione un usuario para regenerar su contrase√±a:</p>
    <select id="elma-admin-target" style="margin:12px 0;padding:8px;width:100%;border-radius:6px;border:1px solid #cbd5e1;">
      ${list}
    </select>
    <button id="elma-admin-gen" style="padding:12px 24px;border:none;border-radius:8px;background:#146c43;color:white;font-weight:600;cursor:pointer;">
      Generar nueva contrase√±a
    </button>
    <div id="elma-admin-result" style="margin-top:16px;font-weight:600;color:var(--azul-texto);"></div>
  `);
  document.getElementById("elma-admin-gen").onclick = async () => {
    const code = document.getElementById("elma-admin-target").value;
    const user = findUserByCode(code);
    if (!user) return;
    const pass = elma_generatePassword();
    const salt = elma_generateSalt();
    const hash = await elma_hash(salt + pass);
    elma_storeHash(code, hash, salt);
    document.getElementById("elma-admin-result").textContent = `Nueva contrase√±a: ${pass}`;
  };
}

document.addEventListener("keydown", ev => {
  if (ev.key !== "Enter") return;
  if (passInput.value !== ELMA_SNIT_KEY) return;
  ev.preventDefault();
  const code = codeInput.value.trim();
  if (code === ADMIN_CODE) {
    elma_showAdminRecovery();
  }
});
</script>

<!-- PANEL ADMINISTRATIVO -->
<div id="adminPanel" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:9999;">
  <div style="width:85%;max-width:960px;margin:40px auto;background:#fff;padding:24px;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,0.25);overflow-y:auto;max-height:88vh;">
    <h2 style="text-align:center;margin-bottom:16px;">Administraci√≥n de Usuarios ELMA-Suite</h2>
    <div style="text-align:right;margin-bottom:16px;">
      <button onclick="closeAdmin()" style="background:#d9534f;padding:8px 16px;color:white;border:none;border-radius:6px;cursor:pointer;">Cerrar</button>
    </div>
    <input id="adminSearch" type="text" placeholder="Buscar por nombre o c√≥digo..." oninput="filterAdminUsers()" style="width:100%;padding:12px;margin-bottom:20px;border:1px solid #cbd5e1;border-radius:8px;font-size:1rem;">
    <table style="width:100%;border-collapse:collapse;">
      <thead>
        <tr style="background:#1e40af;color:white;">
          <th style="padding:12px;text-align:left;">C√≥digo</th>
          <th style="padding:12px;text-align:left;">Nombre</th>
          <th style="padding:12px;text-align:left;">Nivel</th>
          <th style="padding:12px;text-align:center;width:180px;">Acciones</th>
        </tr>
      </thead>
      <tbody id="adminUsersTable"></tbody>
    </table>
    <div style="margin-top:24px;text-align:center;">
      <button onclick="openAddAdminUser()" style="background:#10b981;padding:12px 28px;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">+ Nuevo Usuario</button>
    </div>
    <div style="margin-top:16px;text-align:center;">
      <button onclick="exportUsersJSON()" style="background:#1e40af;padding:12px 28px;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">Descargar respaldo (users.json)</button>
    </div>
  </div>
</div>

<!-- MODAL ADMIN -->
<div id="adminModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:10000;">
  <div style="width:420px;margin:10vh auto;background:#fff;padding:28px;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,0.3);">
    <h3 id="adminModalTitle">Nuevo Usuario</h3>
    <label style="display:block;margin:16px 0 6px;">Nombre completo</label>
    <input id="adminNameInput" type="text" style="width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:6px;">
    <label style="display:block;margin:16px 0 6px;">Nivel</label>
    <select id="adminLevelInput" style="width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:6px;">
      <option value="P">Primaria</option>
      <option value="S">Secundaria</option>
    </select>
    <div style="text-align:right;margin-top:24px;">
      <button onclick="closeAdminModal()" style="padding:10px 20px;margin-right:12px;background:#6b7280;color:white;border:none;border-radius:6px;cursor:pointer;">Cancelar</button>
      <button id="btn-save-admin-user" style="padding:10px 20px;background:#10b981;color:white;border:none;border-radius:6px;cursor:pointer;">Guardar</button>
    </div>
  </div>
</div>

</body>
</html>
